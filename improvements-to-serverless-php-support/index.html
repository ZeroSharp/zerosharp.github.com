
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Improvements to Serverless PHP support - ZeroSharp</title>
  <meta name="author" content="Robert Anderson">

  
  <meta name="description" content="I was inspired by two events to jump back into serverless framework. Firstly, I attended the second London serverless meetup yesterday evening which &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://ZeroSharp.github.com/improvements-to-serverless-php-support/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="http://feeds.feedburner.com/zerosharp" rel="alternate" title="ZeroSharp" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css"> 

<!-- <ra+> -->
<link href="http://fonts.googleapis.com/css?family=Ubuntu:500" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=Inconsolata" rel="stylesheet" type="text/css">

<link href="/stylesheets/custom/data-table.css" media="screen, projection" rel="stylesheet" type="text/css">

<!-- </ra+> -->

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-30564687-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body    class="collapse-sidebar sidebar-footer" >
  <header role="banner"><hgroup>
  <!--<h1><a href="/">ZeroSharp</a></h1>-->
  <a href="http://www.zerosharp.com/"><h1>ZeroSharp</h1></a>
  
    <h2>Robert Anderson's ones and zeros</h2>
  
</hgroup>

</header>
  <nav role="navigation">  

<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:ZeroSharp.github.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>

<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/about/">About</a></li>
  <li><a href="/license/">License</a></li>  
</ul>
<ul class="subscription">
    <li><a rel="me" href="https://plus.google.com/112685056596124127572?rel=author">
      <img src="/images/asides/googleplus.png" width="24" height="24" alt="Rob on Google+">
    </a></li>    
    <li><a rel="me" href="http://twitter.com/8ctopus">
      <img src="/images/asides/twitter.png" width="24" height="24" alt="Rob on Twitter" />
    </a></li>
    <!--<li><a rel="me" href="http://stackoverflow.com/users/1077279/shamp00">
      <img src="/images/asides/stackoverflow.png" width="24" height="24" alt="Rob on StackOverflow" />
    </a></li>
    <li><a rel="me" href="https://github.com/zerosharp">
      <img src="/images/asides/github.png" width="24" height="24" alt="Rob on GitHub" />
    </a></li>
    <li><a rel="me" href="http://www.linkedin.com/profile/view?id=926740"  class ="googleplus-hidden" >
      <img src="/images/asides/linkedin.png" width="24" height="24" alt="Rob on LinkedIn" />
    </a></li>
    <li><a rel="me" href="http://springpad.com/#!/shamp00"  class ="googleplus-hidden" >
      <img src="/images/asides/springpad.png" width="24" height="24" alt="Rob on SpringPad" />
    </a></li>    
    <li><a rel="me" href="http://pinterest.com/shamp00"  class ="googleplus-hidden" >
      <img src="/images/asides/pinterest.png" width="24" height="24" alt="Rob on Pinterest" />
    </a></li>
    <li><a rel="me" href="http://www.last.fm/user/nosredna"  class ="googleplus-hidden" >
      <img src="/images/asides/lastfm.png" width="24" height="24" alt="Rob on Last.fm" />
    </a></li>-->
    <li><a href="http://feeds.feedburner.com/zerosharp">
      <img src="/images/asides/rss.png" rel="subscribe-rss" width="24" height="24" alt="RSS Feed" />
    </a></li>
</ul>
</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Improvements to Serverless PHP Support</h1>
    
    
      <p class="meta">
        








  


<time datetime="2017-03-02T11:37:00+00:00" pubdate data-updated="true">Mar 2<span>nd</span>, 2017</time>
        
         | <a href="#disqus_thread">Comments</a>
        
      </p>
    
  </header>


<div class="entry-content"><p>I was inspired by two events to jump back into serverless framework.</p>

<p><img class="left" src="/images/blog/serverless-php-improvements-001.jpeg" width="200" title="Serverless London Meetup" ></p>

<p>Firstly, I attended the second <a href="https://www.meetup.com/Serverless-London/">London serverless meetup</a> yesterday evening which was excellent and showed just how much enthusiasm there is for serverless architectures. Check out their new logo on the left. It was significant that each of the three speakers announced that they are actively hiring serverless developers.</p>

<p>Secondly, <a href="https://github.com/Stolz">Stolz</a> has contributed improvements to my sample project for integrating PHP into the serverless framework. It&#8217;s the purpose of this blog post to cover the changes.</p>

<p>The trick to getting AWS lambda to support PHP is to bundle in a PHP binary so that nodejs can call it with <code>child_process.spawn()</code>. In <a href="/the-serverless-framework-and-php/">my first implementation</a>, I used an Ubuntu docker base image to compile and produce the php binary. Unfortunately, this is not identical to the container that AWS Lambda uses and so sometimes the logs would contain errors such as:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>START RequestId: 728dcddf-feaa-11e6-8346-2125e1c055d7 Version: <span class="nv">$LATEST</span>
</span><span class='line'>2017-03-01 18:11:10.455 <span class="o">(</span>+00:00<span class="o">)</span>    728dcddf-feaa-11e6-8346-2125e1c055d7    stderr: ./php: /usr/lib64/libcurl.so.4: no version information available <span class="o">(</span>required by ./php<span class="o">)</span>
</span><span class='line'>
</span><span class='line'>END RequestId: 728dcddf-feaa-11e6-8346-2125e1c055d7
</span><span class='line'>REPORT RequestId: 728dcddf-feaa-11e6-8346-2125e1c055d7    Duration: 6000.08 ms    Billed Duration: 6000 ms    Memory Size: 1024 MB    Max Memory Used: 23 MB  
</span></code></pre></td></tr></table></div></figure>


<p>In my experience, these errors were often not fatal, but the correct approach is to build the php binary from a base image which is closer to the one lambda uses. So instead of my docker file starting with <code>FROM ubuntu</code>, it now starts with <code>FROM amazonlinux</code>. Also, with this image, I can use <code>yum</code> to install other dependencies like <code>libpng-devel</code>. So the new docker build script for producing the php binary looks like this:</p>

<figure class='code'><figcaption><span>dockerfile.buildphp</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="c"># Compile PHP with static linked dependencies</span>
</span><span class='line'><span class="c"># to create a single running binary</span>
</span><span class='line'>
</span><span class='line'>FROM amazonlinux
</span><span class='line'>
</span><span class='line'>ARG PHP_VERSION
</span><span class='line'>
</span><span class='line'>RUN yum install <span class="se">\</span>
</span><span class='line'>    autoconf <span class="se">\</span>
</span><span class='line'>    automake <span class="se">\</span>
</span><span class='line'>    libtool <span class="se">\</span>
</span><span class='line'>    bison <span class="se">\</span>
</span><span class='line'>    re2c <span class="se">\</span>
</span><span class='line'>    libxml2-devel <span class="se">\</span>
</span><span class='line'>    openssl-devel <span class="se">\</span>
</span><span class='line'>    libpng-devel <span class="se">\</span>
</span><span class='line'>    libjpeg-devel <span class="se">\</span>
</span><span class='line'>    curl-devel -y
</span><span class='line'>
</span><span class='line'>RUN curl -sL https://github.com/php/php-src/archive/<span class="nv">$PHP_VERSION</span>.tar.gz | tar -zxv
</span><span class='line'>
</span><span class='line'>WORKDIR /php-src-<span class="nv">$PHP_VERSION</span>
</span><span class='line'>
</span><span class='line'>RUN ./buildconf --force
</span><span class='line'>
</span><span class='line'>RUN ./configure <span class="se">\</span>
</span><span class='line'>    --enable-static<span class="o">=</span>yes <span class="se">\</span>
</span><span class='line'>    --enable-shared<span class="o">=</span>no <span class="se">\</span>
</span><span class='line'>    --disable-all <span class="se">\</span>
</span><span class='line'>    --enable-json <span class="se">\</span>
</span><span class='line'>    --enable-libxml <span class="se">\</span>
</span><span class='line'>    --enable-mbstring <span class="se">\</span>
</span><span class='line'>    --enable-phar <span class="se">\</span>
</span><span class='line'>    --enable-soap <span class="se">\</span>
</span><span class='line'>    --enable-xml <span class="se">\</span>
</span><span class='line'>    --with-curl <span class="se">\</span>
</span><span class='line'>    --with-gd <span class="se">\</span>
</span><span class='line'>    --with-zlib <span class="se">\</span>
</span><span class='line'>    --with-openssl <span class="se">\</span>
</span><span class='line'>    --without-pear
</span><span class='line'>
</span><span class='line'>RUN make -j 5
</span></code></pre></td></tr></table></div></figure>


<p>If you run this with</p>

<pre><code>$ sh dockerfile.buildphp
</code></pre>

<p>It will use docker to overwrite the php binary which will get shipped when you deploy with <code>sls deploy</code>. And this time, there are no more libcurl errors. All the code is <a href="https://github.com/ZeroSharp/serverless-php">on Github</a>.</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Robert Anderson</span></span>

      








  


<time datetime="2017-03-02T11:37:00+00:00" pubdate data-updated="true">Mar 2<span>nd</span>, 2017</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/aws/'>aws</a>, <a class='category' href='/blog/categories/lambda/'>lambda</a>, <a class='category' href='/blog/categories/php/'>php</a>, <a class='category' href='/blog/categories/serverless/'>serverless</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://ZeroSharp.github.com/improvements-to-serverless-php-support/" data-via="8ctopus" data-counturl="http://ZeroSharp.github.com/improvements-to-serverless-php-support/" >Tweet</a>
  
  
  <div class="g-plusone" data-size="medium"></div>
  
  
    <div class="fb-like" data-send="true" data-width="450" data-show-faces="false"></div>
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/a-concrete-php-serverless-example/" title="Previous Post: A concrete PHP Serverless example - export chess games in PDF">&laquo; A concrete PHP Serverless example - export chess games in PDF</a>
      
      
        <a class="basic-alignment right" href="/macbook-and-the-mysterious-sleep/" title="Next Post: Macbook and the mysterious sleep">Macbook and the mysterious sleep &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    
  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2017 - Robert Anderson
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'zerosharp';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://ZeroSharp.github.com/improvements-to-serverless-php-support/';
        var disqus_url = 'http://ZeroSharp.github.com/improvements-to-serverless-php-support/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
